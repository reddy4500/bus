<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASWANTH Fleet Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        [contenteditable="true"] {
            cursor: pointer;
            outline: none;
            background-color: rgba(239, 246, 255, 0.5);
            padding: 2px 4px;
            border-radius: 4px;
        }
        [contenteditable="true"]:focus {
            background-color: rgba(224, 231, 255, 1);
            box-shadow: 0 0 0 2px #4f46e5;
        }
        /* Placeholder for empty editable cells */
        [contenteditable=true]:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8; /* slate-400 */
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="flex justify-between items-center mb-8 bg-white/80 backdrop-blur-lg fixed top-4 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] md:w-[calc(100%-4rem)] max-w-7xl z-50 p-4 md:p-6 rounded-xl shadow-lg shadow-slate-900/5">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 8a2 2 0 00-2-2H4a2 2 0 00-2 2v4a2 2 0 002 2h1v1a1 1 0 001 1h10a1 1 0 001-1v-1h1a2 2 0 002-2V8zm-6 3H8V8h4v3z" clip-rule="evenodd" />
                </svg>
                <h1 class="text-3xl font-bold text-indigo-600">Yaswanth</h1>
            </div>
            <nav class="hidden md:flex space-x-8">
                <a href="#" onclick="showPage('home')" class="text-slate-600 hover:text-indigo-500 font-medium transition-colors">Home</a>
                <a href="#" onclick="showPage('bus-wise-audit')" class="text-slate-600 hover:text-indigo-500 font-medium transition-colors">Reports</a>
            </nav>
            <button id="mobile-menu-button" class="md:hidden text-slate-600 hover:text-indigo-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <div id="mobile-menu" class="hidden md:hidden bg-slate-50 rounded-xl shadow-lg mb-8 p-4 fixed top-24 left-4 right-4 z-40">
            <a href="#" onclick="showPage('home')" class="block py-2 text-slate-600 hover:text-indigo-500 rounded-md px-3">Home</a>
            <a href="#" onclick="showPage('bus-wise-audit')" class="block py-2 text-slate-600 hover:text-indigo-500 rounded-md px-3">Reports</a>
        </div>

        <div class="h-24"></div>

        <main id="home" class="page">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold mb-2 text-slate-900">Dashboard</h2>
                <p class="text-slate-500 text-lg">Select an option to begin.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="group bg-slate-50 p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer" onclick="showPage('monthly-audit-selection')">
                    <div class="flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 text-indigo-600 mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold mb-3 text-slate-800">Monthly Audit Entry</h3>
                    <p class="text-slate-500 mb-6">Enter, edit, and review financial data for each month.</p>
                    <span class="font-semibold text-indigo-600 group-hover:underline">
                        Go to Data Entry &rarr;
                    </span>
                </div>
                <div class="group bg-slate-50 p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer" onclick="showPage('bus-wise-audit')">
                     <div class="flex items-center justify-center h-16 w-16 rounded-full bg-teal-100 text-teal-600 mb-6 group-hover:bg-teal-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold mb-3 text-slate-800">View Reports</h3>
                    <p class="text-slate-500 mb-6">Analyze aggregated profit, loss, and revenue data across your fleet.</p>
                     <span class="font-semibold text-teal-600 group-hover:underline">
                        Go to Reports &rarr;
                    </span>
                </div>
            </div>
        </main>

        <section id="monthly-audit-selection" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex items-center mb-8">
                <button onclick="showPage('home')" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Select Audit Period</h2>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <a href="#" onclick="showAuditFile('January')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">January</a>
                <a href="#" onclick="showAuditFile('February')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">February</a>
                <a href="#" onclick="showAuditFile('March')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">March</a>
                <a href="#" onclick="showAuditFile('April')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">April</a>
                <a href="#" onclick="showAuditFile('May')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">May</a>
                <a href="#" onclick="showAuditFile('June')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">June</a>
                <a href="#" onclick="showAuditFile('July')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">July</a>
                <a href="#" onclick="showAuditFile('August')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">August</a>
                <a href="#" onclick="showAuditFile('September')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">September</a>
                <a href="#" onclick="showAuditFile('October')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">October</a>
                <a href="#" onclick="showAuditFile('November')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">November</a>
                <a href="#" onclick="showAuditFile('December')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">December</a>
            </div>
        </section>

        <section id="audit-file" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
             <div class="flex items-center mb-1">
                <button onclick="showPage('monthly-audit-selection')" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Audit File: <span id="audit-file-month"></span></h2>
            </div>
            <p class="text-sm text-slate-500 mb-6 ml-16">Click cells to edit. Totals are updated on blur. Click Save to persist changes.</p>
            
            <div class="flex justify-between items-center mb-4">
                <button onclick="addRow()" class="flex items-center gap-2 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Row
                </button>
                <div class="flex gap-4">
                     <button onclick="exportToCSV()" class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a1 1 0 000-2H4a1 1 0 000 2zM8 16a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zM4 16a1 1 0 011-1h2a1 1 0 110 2H5a1 1 0 01-1-1z" /><path fill-rule="evenodd" d="M5 8a3 3 0 016 0v8a3 3 0 11-6 0V8zm3-1a1 1 0 00-1 1v8a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Export to CSV
                    </button>
                    <button onclick="saveTableData()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-sm font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Save Changes
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border">
                <table class="min-w-full">
                    <thead class="bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">S.No</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bus Number</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Credited Money</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Expenses</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Money Left</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-slate-50 divide-y divide-slate-200" id="audit-table-body">
                    </tbody>
                    <tfoot class="bg-slate-200 font-bold" id="audit-table-foot">
                    </tfoot>
                </table>
            </div>
        </section>

        <section id="bus-wise-audit" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex items-center mb-6">
                <button onclick="showPage('home')" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Aggregated Fleet Reports</h2>
            </div>
            <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div class="lg:col-span-2 bg-white p-6 rounded-lg border shadow-sm">
                    <h3 class="text-xl font-semibold mb-4 text-center text-slate-700">Overall Profit vs. Loss by Bus</h3>
                    <canvas id="busProfitLossChart"></canvas>
                </div>
                <div class="lg:col-span-1 bg-white p-6 rounded-lg border shadow-sm">
                     <h3 class="text-xl font-semibold mb-4 text-center text-slate-700">Total Revenue Share by Bus</h3>
                     <canvas id="revenuePieChart"></canvas>
                </div>
            </div>
            <div id="no-charts-message" class="hidden text-center py-16">
                <h3 class="text-2xl font-semibold text-slate-700">No Data Available</h3>
                <p class="text-slate-500 mt-2">Please enter some data in the 'Monthly Audit Entry' section to generate reports.</p>
            </div>
        </section>

    </div>

    <script>
        const pages = document.querySelectorAll('.page');
        let profitLossChartInstance = null;
        let revenuePieChartInstance = null;
        const DB_NAME = 'fleetAuditData';

        // --- Database Functions ---
        function getDatabase() {
            const db = localStorage.getItem(DB_NAME);
            return db ? JSON.parse(db) : {};
        }

        function saveDatabase(db) {
            localStorage.setItem(DB_NAME, JSON.stringify(db));
            console.log('Database saved.');
        }

        // --- Page Navigation ---
        function showPage(pageId) {
            pages.forEach(page => page.style.display = 'none');
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.style.display = 'block';
            
            document.getElementById('mobile-menu').classList.add('hidden');

            if (pageId === 'bus-wise-audit') {
                createOrUpdateCharts();
            }
        }

        function showAuditFile(month) {
            document.getElementById('audit-file-month').textContent = month;
            const db = getDatabase();
            const monthData = db[month] || [];
            buildTableWithData(monthData);
            showPage('audit-file');
        }

        // --- Table Management ---
        function buildTableWithData(data) {
            const tableBody = document.getElementById('audit-table-body');
            tableBody.innerHTML = '';

            let dataToRender = data.length > 0 ? data : [{ busNumber: '', revenue: '', expense: '' }];

            dataToRender.forEach((rowData, index) => {
                const i = index + 1;
                const row = document.createElement('tr');
                row.className = i % 2 === 0 ? 'bg-slate-100' : 'bg-slate-50';
                row.id = `row-${i}`;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${i}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-900 bus-number-cell" contenteditable="true" data-placeholder="Enter bus no." onblur="updateRowAndTotals()">${rowData.busNumber || ''}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-green-600 revenue-cell" contenteditable="true" data-placeholder="0" onblur="formatCellAsCurrency(this); updateRowAndTotals();">${rowData.revenue ? rowData.revenue.toLocaleString() : ''}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 expense-cell" contenteditable="true" data-placeholder="0" onblur="formatCellAsCurrency(this); updateRowAndTotals();">${rowData.expense ? rowData.expense.toLocaleString() : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium profit-cell"></td>
                    <td class="px-6 py-4 text-center"><button onclick="deleteRow(${i})" class="text-red-400 hover:text-red-600 font-bold text-lg">&times;</button></td>
                `;
                tableBody.appendChild(row);
            });
            updateRowAndTotals();
        }
        
        function addRow() {
            const tableBody = document.getElementById('audit-table-body');
            const newIndex = tableBody.rows.length + 1;
            const newRow = document.createElement('tr');
            newRow.className = newIndex % 2 === 0 ? 'bg-slate-100' : 'bg-slate-50';
            newRow.id = `row-${newIndex}`;
            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${newIndex}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-900 bus-number-cell" contenteditable="true" data-placeholder="Enter bus no." onblur="updateRowAndTotals()"></td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-green-600 revenue-cell" contenteditable="true" data-placeholder="0" onblur="formatCellAsCurrency(this); updateRowAndTotals();"></td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 expense-cell" contenteditable="true" data-placeholder="0" onblur="formatCellAsCurrency(this); updateRowAndTotals();"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium profit-cell"></td>
                <td class="px-6 py-4 text-center"><button onclick="deleteRow(${newIndex})" class="text-red-400 hover:text-red-600 font-bold text-lg">&times;</button></td>
            `;
            tableBody.appendChild(newRow);
            newRow.querySelector('.bus-number-cell').focus();
        }

        function deleteRow(rowIndex) {
            if (confirm('Are you sure you want to delete this row?')) {
                document.getElementById(`row-${rowIndex}`).remove();
                // Re-number all rows after deletion
                const tableBody = document.getElementById('audit-table-body');
                Array.from(tableBody.rows).forEach((row, index) => {
                    const i = index + 1;
                    row.id = `row-${i}`;
                    row.cells[0].textContent = i;
                    row.cells[5].querySelector('button').setAttribute('onclick', `deleteRow(${i})`);
                });
                updateRowAndTotals();
            }
        }
        
        function updateRowAndTotals() {
            const rows = document.querySelectorAll('#audit-table-body tr');
            rows.forEach(row => {
                const revenueCell = row.querySelector('.revenue-cell');
                const expenseCell = row.querySelector('.expense-cell');
                const profitCell = row.querySelector('.profit-cell');

                const revenue = parseCurrency(revenueCell.innerText);
                const expense = parseCurrency(expenseCell.innerText);
                const profit = revenue - expense;

                profitCell.innerText = '₹' + profit.toLocaleString();
                profitCell.classList.toggle('text-green-600', profit >= 0);
                profitCell.classList.toggle('text-red-600', profit < 0);
            });
            updateTableFooter();
        }

        function updateTableFooter() {
            const tableFoot = document.getElementById('audit-table-foot');
            const totalRevenue = sumColumn('.revenue-cell');
            const totalExpense = sumColumn('.expense-cell');
            const totalProfit = totalRevenue - totalExpense;
            
            tableFoot.innerHTML = `
                <tr>
                    <td class="px-6 py-4 text-sm uppercase tracking-wider" colspan="2">Total</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">₹${totalRevenue.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">₹${totalExpense.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}">₹${totalProfit.toLocaleString()}</td>
                    <td class="px-6 py-4"></td>
                </tr>
            `;
        }

        function saveTableData() {
            const month = document.getElementById('audit-file-month').textContent;
            if (!month) return alert('Error: No month selected.');

            const monthData = [];
            const rows = document.querySelectorAll('#audit-table-body tr');
            rows.forEach(row => {
                const busNumber = row.querySelector('.bus-number-cell').innerText.trim().toUpperCase();
                const revenue = parseCurrency(row.querySelector('.revenue-cell').innerText);
                const expense = parseCurrency(row.querySelector('.expense-cell').innerText);
                if (busNumber) {
                    monthData.push({ busNumber, revenue, expense });
                }
            });

            const db = getDatabase();
            db[month] = monthData;
            saveDatabase(db);
            alert(`Data for ${month} saved successfully!`);
        }
        
        // --- Utility Functions ---
        const parseCurrency = (text) => parseFloat(text.replace(/[^0-9.-]+/g, "")) || 0;
        const sumColumn = (selector) => Array.from(document.querySelectorAll(selector)).reduce((acc, cell) => acc + parseCurrency(cell.innerText), 0);

        function formatCellAsCurrency(cell) {
            const value = parseCurrency(cell.innerText);
            cell.innerText = value.toLocaleString();
        }

        function exportToCSV() {
            const month = document.getElementById('audit-file-month').textContent;
            let csvContent = "data:text/csv;charset=utf-8,S.No,Bus Number,Credited Money,Expenses,Money Left\n";
            const rows = document.querySelectorAll('#audit-table-body tr');

            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                const busNumber = cells[1].innerText.trim().replace(/,/g, ''); // Remove commas for CSV
                const revenue = parseCurrency(cells[2].innerText);
                const expense = parseCurrency(cells[3].innerText);
                const profit = parseCurrency(cells[4].innerText);
                if(busNumber) {
                    csvContent += `${index + 1},${busNumber},${revenue},${expense},${profit}\n`;
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `audit_${month.toLowerCase()}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Charting Functions ---
        function createOrUpdateCharts() {
            const db = getDatabase();
            const busData = {}; // { "BUS1": { revenue: X, profit: Y, loss: Z }, ... }
            const hasData = Object.keys(db).length > 0 && Object.values(db).some(month => month.length > 0);

            document.getElementById('charts-container').style.display = hasData ? 'grid' : 'none';
            document.getElementById('no-charts-message').style.display = hasData ? 'none' : 'block';
            if (!hasData) return;

            for (const month in db) {
                db[month].forEach(entry => {
                    const bus = entry.busNumber.toUpperCase();
                    if (!busData[bus]) {
                        busData[bus] = { revenue: 0, profit: 0, loss: 0 };
                    }
                    const profit = entry.revenue - entry.expense;
                    busData[bus].revenue += entry.revenue;
                    if (profit >= 0) {
                        busData[bus].profit += profit;
                    } else {
                        busData[bus].loss += profit;
                    }
                });
            }

            const labels = Object.keys(busData).sort();
            const profitDataset = labels.map(bus => busData[bus].profit);
            const lossDataset = labels.map(bus => busData[bus].loss);
            const revenueDataset = labels.map(bus => busData[bus].revenue);

            createBusProfitLossChart(labels, profitDataset, lossDataset);
            createRevenuePieChart(labels, revenueDataset);
        }

        function createBusProfitLossChart(labels, profitData, lossData) {
            const ctx = document.getElementById('busProfitLossChart').getContext('2d');
            if (profitLossChartInstance) profitLossChartInstance.destroy();
            profitLossChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Profit', data: profitData,
                        backgroundColor: 'rgba(34, 197, 94, 0.7)', 
                        borderColor: 'rgba(22, 163, 74, 1)', borderWidth: 1, borderRadius: 4,
                    }, {
                        label: 'Loss', data: lossData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(220, 38, 38, 1)', borderWidth: 1, borderRadius: 4,
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: value => '₹' + value.toLocaleString() }}}}
            });
        }
        
        function createRevenuePieChart(labels, revenueData) {
            const ctx = document.getElementById('revenuePieChart').getContext('2d');
            if (revenuePieChartInstance) revenuePieChartInstance.destroy();
            revenuePieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Revenue', data: revenueData,
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6', '#6366f1', '#ec4899', '#8b5cf6'],
                        hoverOffset: 8, borderColor: '#f1f5f9',
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }}}
            });
        }

        // --- Initial Load ---
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        window.onload = () => showPage('home');
    </script>

</body>
</html>
