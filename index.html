<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Audit Ledger — Form Entry</title>
<link rel="icon" href="data:;">
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#f4f7fb; color:#0b1730; margin:0; padding:20px}
  .wrap{max-width:1100px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .card{background:white;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(11,23,48,0.06); margin-top:16px}
  form .row{display:flex;gap:8px;flex-wrap:wrap}
  label{font-size:13px;color:#5b6b86}
  input,select{padding:8px;border:1px solid #e7eef8;border-radius:8px;min-width:140px}
  input[type=date]{min-width:160px}
  button{padding:8px 12px;border-radius:8px;border:none;background:#0b66ff;color:white;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #cbdcf9;color:#123}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #eef4fb;text-align:left}
  .muted{color:#5b6b86;font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
  .pill{background:#f1f6ff;padding:8px;border-radius:8px;border:1px solid #e1ecff}
  .right{margin-left:auto}
  .mono{font-family:monospace;font-size:13px}
  .small{font-size:12px;color:#5b6b86}
  .actions{display:flex;gap:8px}
  .danger{background:#ff5c6d}
  .kbd{background:#eef4fb;padding:4px 8px;border-radius:6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Audit Ledger — Form Entry (from 1.jan audit.xlsx)</h1>
    <div class="small">Client-side only • ready for GitHub Pages</div>
  </header>

  <section class="card" id="entryCard">
    <h2 style="margin-top:0">Add / Edit Entry</h2>
    <form id="entryForm" onsubmit="return false;">
      <div class="row">
        <label>Date<br/><input type="date" id="f_date" required></label>
        <label>PARTICULARS<br/><input id="f_part" placeholder="Particulars"></label>
        <label>Vch Type<br/><input id="f_vtype" placeholder="Voucher type"></label>
        <label>Vch No.<br/><input id="f_vno" placeholder="Voucher no."></label>
        <label>Debit<br/><input id="f_debit" type="number" step="0.01" min="0" value="0"></label>
        <label>Credit<br/><input id="f_credit" type="number" step="0.01" min="0" value="0"></label>
      </div>
      <div style="margin-top:10px" class="controls">
        <div class="actions">
          <button id="btnAdd">Add Entry</button>
          <button id="btnUpdate" class="ghost" style="display:none">Update</button>
          <button id="btnClear" type="button" class="ghost">Clear</button>
        </div>
        <div class="right"><span class="small">Shortcut: Press <span class="kbd">Enter</span> to add</span></div>
      </div>
    </form>
  </section>

  <section class="card" id="tableCard">
    <h2 style="margin-top:0">Entries</h2>
    <div class="muted">Rows are stored in your browser. Edit / Delete as needed. Running balance is computed as cumulative (Debit - Credit) by date order.</div>
    <div style="margin-top:12px" class="controls">
      <input id="filterMonth" type="month" />
      <select id="filterVtype"><option value="">-- Filter Vch Type --</option></select>
      <button id="btnApplyFilter" class="ghost">Apply</button>
      <button id="btnResetFilter" class="ghost">Reset</button>
      <div class="right actions">
        <button id="btnExportCSV" class="ghost">Export CSV</button>
        <button id="btnExportXLS" class="ghost">Export Excel</button>
        <button id="btnClearAll" class="danger">Clear All</button>
      </div>
    </div>

    <div id="tableWrap" style="overflow:auto;margin-top:12px">
      <table id="entriesTable">
        <thead><tr>
          <th>#</th><th>Date</th><th>Particulars</th><th>Vch Type</th><th>Vch No.</th><th>Debit</th><th>Credit</th><th>Running Balance</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card" id="summaryCard">
    <h2 style="margin-top:0">Summaries & Reports</h2>
    <div class="summary-grid">
      <div class="pill">
        <div class="small">Total Debit</div>
        <div id="totalDebit" class="mono">0.00</div>
      </div>
      <div class="pill">
        <div class="small">Total Credit</div>
        <div id="totalCredit" class="mono">0.00</div>
      </div>
      <div class="pill">
        <div class="small">Closing Balance (Debit - Credit)</div>
        <div id="closingBalance" class="mono">0.00</div>
      </div>
      <div class="pill">
        <div class="small">Number of Entries</div>
        <div id="countEntries" class="mono">0</div>
      </div>
    </div>

    <h3 style="margin-top:12px">Monthly Totals</h3>
    <div id="monthlyOut" style="margin-top:8px"></div>

    <h3 style="margin-top:12px">Group by Voucher Type</h3>
    <div id="vtypeOut" style="margin-top:8px"></div>
  </section>

  <footer style="margin-top:16px" class="small muted">Exported files include current filters and running-balance column. Data only stored in browser unless exported.</footer>
</div>

<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
<script>
(function(){
  // Utilities
  const $ = id => document.getElementById(id);
  const lsKey = 'form_audit_entries_v1';
  let entries = []; // {id,date,part,vtype,vno,debit,credit}
  let editId = null;
  // Elements
  const tblBody = document.querySelector('#entriesTable tbody');
  const f_date = $('f_date'), f_part = $('f_part'), f_vtype = $('f_vtype'), f_vno = $('f_vno'), f_debit = $('f_debit'), f_credit = $('f_credit');
  const btnAdd = $('btnAdd'), btnUpdate = $('btnUpdate'), btnClear = $('btnClear'), btnClearAll = $('btnClearAll');
  const filterMonth = $('filterMonth'), filterVtype = $('filterVtype'), btnApplyFilter = $('btnApplyFilter'), btnResetFilter = $('btnResetFilter');
  const totalDebitEl = $('totalDebit'), totalCreditEl = $('totalCredit'), closingBalanceEl = $('closingBalance'), countEntriesEl = $('countEntries');
  const monthlyOut = $('monthlyOut'), vtypeOut = $('vtypeOut');
  const btnExportCSV = $('btnExportCSV'), btnExportXLS = $('btnExportXLS');

  // Load initial from uploaded Excel: if the server had an original file, but we will try to prefill using embedded sample if localStorage empty
  function load(){
    try{
      const s = localStorage.getItem(lsKey);
      if(s){ entries = JSON.parse(s); }
      else {
        // If no saved entries, try to preload with sample rows from server-side (we embed none). Keep empty.
        entries = [];
      }
    }catch(e){ entries = []; }
    renderAll();
  }
  function save(){
    localStorage.setItem(lsKey, JSON.stringify(entries));
  }

  // Add or update
  btnAdd.addEventListener('click', ()=>{
    const dt = f_date.value;
    if(!dt){ alert('Please select Date'); return; }
    const rec = {
      id: Date.now().toString(),
      date: dt,
      part: f_part.value || '',
      vtype: f_vtype.value || '',
      vno: f_vno.value || '',
      debit: parseFloat(f_debit.value || 0) || 0,
      credit: parseFloat(f_credit.value || 0) || 0
    };
    entries.push(rec);
    entries.sort((a,b)=> new Date(a.date) - new Date(b.date) || a.id - b.id);
    save(); renderAll(); clearForm();
  });
  btnUpdate.addEventListener('click', ()=>{
    if(!editId) return;
    const rec = entries.find(r=>r.id===editId);
    if(!rec) return;
    rec.date = f_date.value; rec.part = f_part.value; rec.vtype = f_vtype.value; rec.vno = f_vno.value;
    rec.debit = parseFloat(f_debit.value || 0) || 0; rec.credit = parseFloat(f_credit.value || 0) || 0;
    entries.sort((a,b)=> new Date(a.date) - new Date(b.date) || a.id - b.id);
    editId = null;
    btnUpdate.style.display='none'; btnAdd.style.display='inline-block';
    save(); renderAll(); clearForm();
  });
  btnClear.addEventListener('click', clearForm);
  btnClearAll.addEventListener('click', ()=>{
    if(!confirm('Clear all entries from browser storage?')) return;
    entries = []; save(); renderAll();
  });

  function clearForm(){
    editId = null; f_date.value=''; f_part.value=''; f_vtype.value=''; f_vno.value=''; f_debit.value='0'; f_credit.value='0';
    btnUpdate.style.display='none'; btnAdd.style.display='inline-block';
  }

  // Render table, summaries
  function renderAll(){
    // Apply filters if any
    const month = filterMonth.value; const vfilter = filterVtype.value;
    let rows = entries.slice();
    if(month){
      rows = rows.filter(r=> r.date.startsWith(month));
    }
    if(vfilter){
      rows = rows.filter(r=> r.vtype === vfilter);
    }
    // Ensure sorted by date
    rows.sort((a,b)=> new Date(a.date) - new Date(b.date) || a.id - b.id);
    // Calculate running balance
    let running = 0;
    const rendered = rows.map(r=>{
      running += (Number(r.debit)||0) - (Number(r.credit)||0);
      return Object.assign({}, r, {running: running});
    });
    // Table
    tblBody.innerHTML = '';
    rendered.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.date}</td><td>${escapeHtml(r.part)}</td><td>${escapeHtml(r.vtype)}</td><td>${escapeHtml(r.vno)}</td><td class="mono">${num(r.debit)}</td><td class="mono">${num(r.credit)}</td><td class="mono">${num(r.running)}</td><td><button data-id="${r.id}" class="editBtn">Edit</button> <button data-id="${r.id}" class="delBtn">Delete</button></td>`;
      tblBody.appendChild(tr);
    });
    // wire actions
    document.querySelectorAll('.editBtn').forEach(b=>b.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id; startEdit(id);
    }));
    document.querySelectorAll('.delBtn').forEach(b=>b.addEventListener('click', e=>{
      const id = e.currentTarget.dataset.id; if(!confirm('Delete this row?')) return;
      entries = entries.filter(x=>x.id!==id); save(); renderAll();
    }));

    // Summaries (for ALL entries, not filtered)
    const totalDebit = entries.reduce((s,r)=>s + (+r.debit||0),0);
    const totalCredit = entries.reduce((s,r)=>s + (+r.credit||0),0);
    totalDebitEl.textContent = num(totalDebit);
    totalCreditEl.textContent = num(totalCredit);
    closingBalanceEl.textContent = num(totalDebit - totalCredit);
    countEntriesEl.textContent = entries.length;

    // Monthly totals (group by YYYY-MM)
    const months = {};
    entries.forEach(r=>{
      const m = r.date.slice(0,7); // YYYY-MM
      if(!months[m]) months[m] = {debit:0, credit:0};
      months[m].debit += +r.debit||0; months[m].credit += +r.credit||0;
    });
    monthlyOut.innerHTML = '';
    if(Object.keys(months).length===0) monthlyOut.innerHTML = '<div class="small muted">No data</div>';
    else{
      const t = document.createElement('table'); t.style.width='100%';
      t.innerHTML = '<thead><tr><th>Month</th><th>Total Debit</th><th>Total Credit</th><th>Difference</th></tr></thead>';
      const tb = document.createElement('tbody');
      Object.keys(months).sort().forEach(m=>{
        const d = months[m]; const diff = d.debit - d.credit;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m}</td><td class="mono">${num(d.debit)}</td><td class="mono">${num(d.credit)}</td><td class="mono">${num(diff)}</td>`;
        tb.appendChild(tr);
      });
      t.appendChild(tb); monthlyOut.appendChild(t);
    }

    // Group by vtype
    const types = {};
    entries.forEach(r=>{
      const t = r.vtype || '(empty)'; if(!types[t]) types[t]={debit:0,credit:0,count:0};
      types[t].debit += +r.debit||0; types[t].credit += +r.credit||0; types[t].count +=1;
    });
    vtypeOut.innerHTML = '';
    if(Object.keys(types).length===0) vtypeOut.innerHTML = '<div class="small muted">No data</div>';
    else {
      const t = document.createElement('table'); t.style.width='100%';
      t.innerHTML = '<thead><tr><th>Vch Type</th><th>Count</th><th>Total Debit</th><th>Total Credit</th><th>Difference</th></tr></thead>';
      const tb = document.createElement('tbody');
      Object.keys(types).sort().forEach(k=>{
        const d = types[k]; const diff = d.debit - d.credit;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(k)}</td><td>${d.count}</td><td class="mono">${num(d.debit)}</td><td class="mono">${num(d.credit)}</td><td class="mono">${num(diff)}</td>`;
        tb.appendChild(tr);
      });
      t.appendChild(tb); vtypeOut.appendChild(t);
    }

    // Populate vtype filter selector with unique types
    const set = new Set(entries.map(r=>r.vtype || '').filter(x=>x!==''));
    const old = filterVtype.value;
    filterVtype.innerHTML = '<option value="">-- Filter Vch Type --</option>';
    Array.from(set).sort().forEach(v=>{
      const opt = document.createElement('option'); opt.value=v; opt.textContent=v; filterVtype.appendChild(opt);
    });
    filterVtype.value = old || '';

  }

  function startEdit(id){
    const rec = entries.find(x=>x.id===id);
    if(!rec) return;
    editId = id;
    f_date.value = rec.date; f_part.value = rec.part; f_vtype.value = rec.vtype; f_vno.value = rec.vno;
    f_debit.value = rec.debit; f_credit.value = rec.credit;
    btnUpdate.style.display='inline-block'; btnAdd.style.display='none';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // Filters
  btnApplyFilter.addEventListener('click', renderAll);
  btnResetFilter.addEventListener('click', ()=>{ filterMonth.value=''; filterVtype.value=''; renderAll(); });

  // Export to CSV/Excel (current filtered view with running balance)
  function exportRows(){
    const month = filterMonth.value; const vfilter = filterVtype.value;
    let rows = entries.slice();
    if(month) rows = rows.filter(r=> r.date.startsWith(month));
    if(vfilter) rows = rows.filter(r=> r.vtype === vfilter);
    rows.sort((a,b)=> new Date(a.date) - new Date(b.date) || a.id - b.id);
    let running=0;
    const out = rows.map((r,i)=>{
      running += (Number(r.debit)||0) - (Number(r.credit)||0);
      return {
        '#': i+1,
        Date: r.date,
        Particulars: r.part,
        'Vch Type': r.vtype,
        'Vch No.': r.vno,
        Debit: num(r.debit),
        Credit: num(r.credit),
        'Running Balance': num(running)
      };
    });
    return out;
  }

  btnExportCSV.addEventListener('click', ()=>{
    const rows = exportRows();
    if(!rows.length){ alert('No rows to export'); return; }
    const cols = Object.keys(rows[0]);
    const lines = [cols.join(',')];
    rows.forEach(r=>{
      lines.push(cols.map(c=>`"${String(r[c]||'').replace(/"/g,'""')}"`).join(','));
    });
    const blob = new Blob([lines.join('\\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='audit_export.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  });

  btnExportXLS.addEventListener('click', ()=>{
    const rows = exportRows();
    if(!rows.length){ alert('No rows to export'); return; }
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Audit');
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    const blob = new Blob([wbout], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='audit_export.xlsx'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  });

  // Helpers
  function num(x){ return Number(x || 0).toFixed(2); }
  function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Keyboard: Enter in any field adds
  document.getElementById('entryForm').addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); if(btnAdd.style.display!=='none') btnAdd.click(); else btnUpdate.click(); }
  });

  // Initialize
  load();

  // Expose for debugging (optional)
  window._audit = {getEntries: ()=>entries, clear: ()=>{ entries=[]; save(); renderAll(); }};

})();
</script>
</body>
</html>
