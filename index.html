<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Audit & Calculator</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg: #0b1020; --panel: #121831; --muted:#9aa4bf; --text:#f3f5ff; --accent:#6aa6ff; --accent2:#7cfaa3; --danger:#ff6a8e;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg, #0b1020, #10162e) fixed; color:var(--text)}
    .wrap{max-width:1100px; margin:40px auto; padding:0 16px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:clamp(1.4rem, 2.2vw, 2rem); margin:0}
    .card{background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grid{display:grid; gap:16px}
    @media (min-width:900px){ .grid-2{grid-template-columns:1.2fr .8fr} }
    .btn{appearance:none; background:var(--accent); color:#050814; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer}
    .btn.secondary{ background:#232a4d; color:var(--text) }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.18); color:var(--text) }
    .btn.danger{ background:var(--danger) }
    .muted{color:var(--muted)}
    .upload{border:2px dashed rgba(255,255,255,0.18); border-radius:16px; padding:18px; text-align:center}
    .upload.dragover{background:rgba(106,166,255,.1)}
    input[type="file"]{display:none}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select, input[type="text"]{background:#0f1530; color:var(--text); border:1px solid rgba(255,255,255,0.18); border-radius:12px; padding:10px; min-width:180px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{border-bottom:1px solid rgba(255,255,255,0.08); padding:8px 10px; text-align:left}
    thead th{position:sticky; top:0; background:#0e1430; z-index:1}
    .scroller{max-height:380px; overflow:auto; border:1px solid rgba(255,255,255,0.08); border-radius:12px}
    .pill{display:inline-flex; align-items:center; gap:8px; background:#0e1533; border:1px solid rgba(255,255,255,0.12); padding:8px 12px; border-radius:999px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    footer{margin:24px 0; color:#7f8ab5; font-size:12px}
    .kbd{padding:2px 6px; border:1px solid rgba(255,255,255,0.2); border-bottom-width:2px; border-radius:6px; font-family:inherit; font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Excel Audit & Calculator</h1>
      <div class="row">
        <button id="btnExportSummaryCSV" class="btn secondary" disabled>Export Summary CSV</button>
        <button id="btnExportSummaryJSON" class="btn ghost" disabled>Export Summary JSON</button>
        <a id="btnDownloadTemplate" class="btn" href="#" download="data_template.xlsx">Download Template</a>
      </div>
    </header>

    <div class="grid grid-2">
      <section class="card">
        <h2 style="margin-top:0">1) Upload Excel</h2>
        <div class="upload" id="drop">
          <p class="muted">Drop your <span class="pill"><span class="mono">.xlsx</span> / <span class="mono">.xls</span> / <span class="mono">.csv</span></span> here<br/>or</p>
          <label class="btn">
            <input type="file" id="file" accept=".xlsx,.xls,.csv"/>
            Choose a file
          </label>
        </div>

        <div style="margin-top:16px" class="row">
          <label class="pill">Sheet:
            <select id="sheetSelect"></select>
          </label>
          <button id="btnAnalyze" class="btn">Analyze</button>
          <button id="btnClear" class="btn ghost">Clear</button>
        </div>

        <div id="fileInfo" class="muted" style="margin-top:8px"></div>

        <div id="tableWrap" class="scroller" style="margin-top:16px">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2 style="margin-top:0">2) Calculations</h2>
        <p class="muted">Automatic numeric column statistics: <span class="mono">count</span>, <span class="mono">sum</span>, <span class="mono">mean</span>, <span class="mono">min</span>, <span class="mono">max</span>, <span class="mono">std</span>.</p>
        <div id="summary" class="scroller" style="max-height:240px"></div>

        <h3>Group by (Pivot-lite)</h3>
        <div class="row">
          <select id="groupSelect"></select>
          <select id="aggSelect">
            <option value="sum">Sum</option>
            <option value="mean">Mean</option>
            <option value="count">Count</option>
            <option value="min">Min</option>
            <option value="max">Max</option>
          </select>
          <button id="btnGroup" class="btn secondary">Run</button>
          <button id="btnExportGroupCSV" class="btn ghost" disabled>Export Group CSV</button>
        </div>
        <div id="groupOut" class="scroller" style="margin-top:12px; max-height:200px"></div>
      </section>
    </div>

    <footer>
      Tip: You can switch sheets via the dropdown. Keyboard: <span class="kbd">G</span> to focus Group, <span class="kbd">A</span> Analyze, <span class="kbd">C</span> Clear.
    </footer>
  </div>

  <!-- SheetJS for parsing Excel in-browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <script>
    const el = (q)=>document.querySelector(q);
    const tbl = {
      head: el('#dataTable thead'),
      body: el('#dataTable tbody'),
    };
    const drop = el('#drop');
    const fileInput = el('#file');
    const sheetSel = el('#sheetSelect');
    const groupSel = el('#groupSelect');
    const aggSel = el('#aggSelect');
    const info = el('#fileInfo');
    const btnAnalyze = el('#btnAnalyze');
    const btnClear = el('#btnClear');
    const btnGroup = el('#btnGroup');
    const btnExportSummaryCSV = el('#btnExportSummaryCSV');
    const btnExportSummaryJSON = el('#btnExportSummaryJSON');
    const btnExportGroupCSV = el('#btnExportGroupCSV');
    const btnDownloadTemplate = el('#btnDownloadTemplate');
    const summaryBox = el('#summary');
    const groupOut = el('#groupOut');
    const tableWrap = el('#tableWrap');

    let workbook = null;
    let rawData = [];
    let currentSheet = null;
    let summary = null;
    let groupResult = null;

    // Template file (generated dynamically)
    function generateTemplate(){
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([
        ["Date","Category","Item","Qty","Price","Amount"],
        ["2025-01-01","A","Sample",2,100,200]
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      const blob = XLSX.write(wb, {bookType:"xlsx", type:"array"});
      const url = URL.createObjectURL(new Blob([blob], {type: "application/octet-stream"}));
      btnDownloadTemplate.href = url;
    }

    generateTemplate();

    // Drag & drop
    ;['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => {e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover');}));
    ;['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => {e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover');}));
    drop.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if(f) loadFile(f);
    });

    fileInput.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if(f) loadFile(f);
    });

    function loadFile(file){
      const reader = new FileReader();
      const isCSV = /\.csv$/i.test(file.name);
      reader.onload = (evt)=>{
        try{
          let data = evt.target.result;
          if(isCSV){
            const wb = XLSX.read(data, {type:'string'});
            handleWorkbook(wb, file);
          } else {
            const wb = XLSX.read(data, {type:'binary'});
            handleWorkbook(wb, file);
          }
        }catch(err){
          alert('Failed to read file: ' + err.message);
        }
      };
      if(isCSV) reader.readAsText(file);
      else reader.readAsBinaryString(file);
    }

    function handleWorkbook(wb, file){
      workbook = wb;
      sheetSel.innerHTML = '';
      wb.SheetNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sheetSel.appendChild(opt);
      });
      currentSheet = wb.SheetNames[0];
      info.textContent = `Loaded: ${file.name} â€¢ Sheets: ${wb.SheetNames.length}`;
      renderSheet(currentSheet);
    }

    sheetSel.addEventListener('change', e => {
      currentSheet = e.target.value;
      renderSheet(currentSheet);
    });

    function renderSheet(name){
      const ws = workbook.Sheets[name];
      const json = XLSX.utils.sheet_to_json(ws, {defval:null});
      rawData = json;
      renderTable(json);
      prepareGroupControls(json);
      summary = null;
      groupResult = null;
      summaryBox.innerHTML = '';
      groupOut.innerHTML = '';
      btnExportSummaryCSV.disabled = true;
      btnExportSummaryJSON.disabled = true;
      btnExportGroupCSV.disabled = true;
    }

    function renderTable(rows){
      tbl.head.innerHTML = '';
      tbl.body.innerHTML = '';

      if(!rows.length){
        tbl.head.innerHTML = '<tr><th>No data</th></tr>';
        return;
      }

      const cols = Object.keys(rows[0]);
      const trh = document.createElement('tr');
      cols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        trh.appendChild(th);
      });
      tbl.head.appendChild(trh);

      const MAX_ROWS = 1000; // cap render for performance
      rows.slice(0, MAX_ROWS).forEach(r => {
        const tr = document.createElement('tr');
        cols.forEach(c => {
          const td = document.createElement('td');
          const v = r[c];
          td.textContent = v===null ? '' : v;
          tr.appendChild(td);
        });
        tbl.body.appendChild(tr);
      });

      if(rows.length > MAX_ROWS){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = cols.length;
        td.className = 'muted';
        td.textContent = `Showing first ${MAX_ROWS} of ${rows.length} rowsâ€¦`;
        tr.appendChild(td);
        tbl.body.appendChild(tr);
      }
    }

    // Analyze numeric columns
    function isNumber(x){
      return typeof x === 'number' && isFinite(x);
    }
    function toNumber(val){
      if(typeof val === 'number') return val;
      if(typeof val === 'string' && val.trim() !== ''){
        const n = Number(val.replace(/[,\s]/g,''));
        return isFinite(n) ? n : null;
      }
      return null;
    }
    function analyze(){
      if(!rawData.length){ alert('No data to analyze'); return; }
      const cols = Object.keys(rawData[0]);
      const numericCols = cols.filter(c => rawData.some(r => isNumber(toNumber(r[c]))));
      const stats = {};
      numericCols.forEach(c => {
        const vals = rawData.map(r => toNumber(r[c])).filter(v => v!==null);
        if(!vals.length) return;
        const count = vals.length;
        const sum = vals.reduce((a,b)=>a+b, 0);
        const mean = sum / count;
        const min = Math.min.apply(null, vals);
        const max = Math.max.apply(null, vals);
        const variance = vals.reduce((a,b)=>a + Math.pow(b-mean,2), 0) / (count-1 || 1);
        const std = Math.sqrt(variance);
        stats[c] = {count, sum, mean, min, max, std};
      });
      summary = stats;
      renderSummary(stats);
      btnExportSummaryCSV.disabled = false;
      btnExportSummaryJSON.disabled = false;
    }

    function renderSummary(stats){
      if(!Object.keys(stats).length){
        summaryBox.innerHTML = '<p class="muted">No numeric columns found.</p>';
        return;
      }
      const headers = ['Column','count','sum','mean','min','max','std'];
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      Object.entries(stats).forEach(([k,v])=>{
        const tr = document.createElement('tr');
        [k, v.count, v.sum, v.mean, v.min, v.max, v.std].forEach(x => {
          const td = document.createElement('td');
          td.textContent = typeof x === 'number' ? String(Math.round(x*1e6)/1e6) : x;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      summaryBox.innerHTML = '';
      summaryBox.appendChild(table);
    }

    // Group-by aggregation
    function prepareGroupControls(rows){
      groupSel.innerHTML = '';
      if(!rows.length) return;
      const cols = Object.keys(rows[0]);
      cols.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        groupSel.appendChild(opt);
      });
    }

    function groupBy(){
      if(!rawData.length){ alert('No data'); return; }
      const col = groupSel.value;
      const agg = aggSel.value;
      // Detect numeric columns for aggregation targets
      const cols = Object.keys(rawData[0]).filter(c => c !== col);
      const targetNumericCols = cols.filter(c => rawData.some(r => isNumber(toNumber(r[c]))));
      if(!targetNumericCols.length){
        groupOut.innerHTML = '<p class="muted">No numeric columns to aggregate.</p>';
        return;
      }
      const groups = new Map();
      rawData.forEach(r => {
        const key = String(r[col]);
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      });
      const rows = [];
      for(const [k, arr] of groups){
        const out = { [col]: k };
        targetNumericCols.forEach(tc => {
          const vals = arr.map(r => toNumber(r[tc])).filter(v => v!==null);
          if(!vals.length){ out[tc] = null; return; }
          let val = null;
          switch(agg){
            case 'sum': val = vals.reduce((a,b)=>a+b,0); break;
            case 'mean': val = vals.reduce((a,b)=>a+b,0)/vals.length; break;
            case 'count': val = vals.length; break;
            case 'min': val = Math.min.apply(null, vals); break;
            case 'max': val = Math.max.apply(null, vals); break;
          }
          out[tc] = val;
        });
        rows.push(out);
      }
      // render
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      const headers = Object.keys(rows[0] || { [col]: col });
      headers.forEach(h => { const th = document.createElement('th'); th.textContent=h; trh.appendChild(th); });
      thead.appendChild(trh);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          const v = r[h];
          td.textContent = (typeof v === 'number' && isFinite(v)) ? String(Math.round(v*1e6)/1e6) : (v ?? '');
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      groupOut.innerHTML = '';
      groupOut.appendChild(table);
      groupResult = rows;
      btnExportGroupCSV.disabled = false;
    }

    // Export helpers
    function toCSV(rows){
      if(!rows || !rows.length) return '';
      const cols = Object.keys(rows[0]);
      const lines = [cols.join(',')];
      rows.forEach(r => {
        lines.push(cols.map(c => {
          const v = r[c];
          if(v === null || v === undefined) return '';
          const s = String(v).replace(/"/g,'""');
          return /[",\n]/.test(s) ? `"${s}"` : s;
        }).join(','));
      });
      return lines.join('\n');
    }

    btnAnalyze.addEventListener('click', analyze);
    btnClear.addEventListener('click', ()=>{
      workbook = null; rawData = []; currentSheet = null; summary = null; groupResult = null;
      tbl.head.innerHTML = ''; tbl.body.innerHTML = ''; sheetSel.innerHTML=''; groupSel.innerHTML='';
      summaryBox.innerHTML = ''; groupOut.innerHTML = ''; info.textContent = '';
      btnExportSummaryCSV.disabled = true; btnExportSummaryJSON.disabled = true; btnExportGroupCSV.disabled = true;
    });
    btnGroup.addEventListener('click', groupBy);

    btnExportSummaryCSV.addEventListener('click', ()=>{
      if(!summary) return;
      const rows = Object.entries(summary).map(([k,v])=>({Column:k, ...v}));
      const csv = toCSV(rows);
      const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      const a = document.createElement('a'); a.href = url; a.download = 'summary.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });
    btnExportSummaryJSON.addEventListener('click', ()=>{
      if(!summary) return;
      const blob = new Blob([JSON.stringify(summary, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'summary.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });
    btnExportGroupCSV.addEventListener('click', ()=>{
      if(!groupResult) return;
      const csv = toCSV(groupResult);
      const url = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      const a = document.createElement('a'); a.href = url; a.download = 'groupby.csv'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });

    // keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='a') btnAnalyze.click();
      if(e.key.toLowerCase()==='g') groupSel.focus();
      if(e.key.toLowerCase()==='c') btnClear.click();
    });
  </script>
</body>
</html>
